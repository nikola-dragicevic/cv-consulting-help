# Quick Fix for CV Upload RLS Error

## The Problem

You're getting: **"CV upload failed: new row violates row-level security policy"**

**Root cause**: Your `candidate_profiles` table has rows where `user_id = null`, and RLS requires `user_id = auth.uid()`.

## The Solution (5 Steps)

### Step 1: Run RLS Migration in Supabase

1. Open **Supabase Dashboard → SQL Editor**
2. Copy contents from `supabase/migrations/20250125_fix_rls_policies.sql`
3. Click **Run**

This creates proper RLS policies and constraints.

### Step 2: Create Helper Function

In **Supabase SQL Editor**, run:

```sql
CREATE OR REPLACE FUNCTION get_user_by_email(email_param TEXT)
RETURNS TABLE (id UUID, email TEXT)
SECURITY DEFINER
SET search_path = public, auth
AS $$
BEGIN
    RETURN QUERY
    SELECT auth.users.id, auth.users.email::TEXT
    FROM auth.users
    WHERE auth.users.email = email_param;
END;
$$ LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION get_user_by_email(TEXT) TO service_role;
```

### Step 3: Link Existing Profiles to Users

Run in your terminal:

```bash
python scripts/link_profiles_to_users.py
```

This matches existing profiles to auth users by email.

### Step 4: Test Registration & Upload

1. Register a new user at `/signup`
2. Confirm email (check inbox/spam)
3. Login at `/login`
4. Go to `/profile` and upload a CV
5. Should work now! ✅

### Step 5: Vectorize the CV

After uploading, run:

```bash
# Make sure Ollama is running first
ollama serve

# Then vectorize
python scripts/generate_candidate_vector.py
```

## Architecture: auth.users vs candidate_profiles

### auth.users (Supabase Managed)
- Email/password authentication
- Session management
- Secure by default
- **You access via**: `auth.uid()` in RLS policies

### candidate_profiles (Your Custom Table)
- Extended user data (CV, phone, address, etc.)
- Job matching vectors
- Quiz answers, preferences
- **Linked to auth.users via**: `user_id` foreign key

**Both are required!** Supabase auth handles login, your table stores everything else.

## How It Works Now

```
1. User registers → auth.users row created
2. User uploads CV → candidate_profiles row created with user_id = auth.uid()
3. RLS checks: user_id matches auth.uid() ✅
4. CV saved to storage
5. Vector generated by script (uses service_role key)
```

## Verify Everything Works

```sql
-- Check your profile is linked
SELECT
  cp.id,
  cp.email,
  cp.full_name,
  cp.user_id,
  cp.cv_file_url IS NOT NULL as has_cv,
  cp.vector IS NOT NULL as has_vector,
  au.email as auth_email
FROM candidate_profiles cp
LEFT JOIN auth.users au ON cp.user_id = au.id
WHERE cp.email = 'your-email@example.com';
```

## Troubleshooting

### Still getting RLS error?
- Check user is logged in: `/api/profile` should return 401 if not
- Verify `user_id` is set in the profile row
- Check browser console for auth errors

### CV not uploading?
- Verify `cvs` storage bucket exists in Supabase
- Check bucket permissions (should be public or use signed URLs)
- Ensure file is PDF or .txt

### Vector not generated?
- Check Ollama is running: `ollama list | grep nomic-embed-text`
- Verify `.env` has `SUPABASE_SERVICE_KEY`
- Check logs in `logs/failed_candidates.jsonl`

## Questions?

- **Should I use auth.users or candidate_profiles?** Both! Link them with `user_id`.
- **Can I delete old profiles with null user_id?** Yes, after linking them or if they're test data.
- **How do I automate vectorization?** Set up a cron job or Supabase webhook to run the script.

---

Read `docs/RLS_AND_CV_SETUP.md` for detailed explanation.
